<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>警報の履歴（過去14日間）</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f1f6f9;
      margin: 0 0 60px 0; /* 下に固定ボタンのスペース確保 */
      padding: 20px;
    }
    .card {
      max-width: 700px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      padding: 24px;
    }
    h1 {
      text-align: center;
      color: #1677c1;
      margin-bottom: 16px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      text-align: center;
      word-break: break-word;
    }
    th {
      background-color: #e8f4fc;
      color: #333;
    }
    tr:hover {
      background-color: #f5fbff;
    }
    /* 固定ボタン */
    .back {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      width: 90%;
      max-width: 700px;
      z-index: 100;
    }
    .back a {
      display: block;
      margin: 0 auto;
      width: 100%;
      max-width: 700px;
      box-sizing: border-box;
      text-decoration: none;
      background-color: #1677c1;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      box-shadow: 0 3px 6px rgba(22, 119, 193, 0.4);
      transition: background-color 0.3s ease;
    }
    .back a:hover {
      background-color: #125a93;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>警報の履歴（過去14日間）</h1>
    <table>
      <thead>
        <tr>
          <th>日付</th>
          <th>時刻</th>
          <th>発令状況</th>
          <th>警報の種類</th>
        </tr>
      </thead>
      <tbody id="alert-log">
        <tr><td colspan="4">読み込み中...</td></tr>
      </tbody>
    </table>
  </div>

  <div class="back">
    <a href="index.html">メイン画面へ戻る</a>
  </div>

  <script>
    function jsonpCallback(data) {
      console.log('警報ログ JSONPデータ:', data);

      const tbody = document.getElementById('alert-log');
      tbody.innerHTML = '';

      if (!data || data.error) {
        tbody.innerHTML = `<tr><td colspan="4">データ取得エラー</td></tr>`;
        return;
      }

      if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4">データなし</td></tr>`;
        return;
      }

      // 日付で降順ソート（新しい順）
      data.sort((a, b) => {
        const dateA = new Date(a.date + ' ' + (a.time || '00:00'));
        const dateB = new Date(b.date + ' ' + (b.time || '00:00'));
        return dateB - dateA;
      });

      data.forEach(row => {
        const tr = document.createElement('tr');

        // typesが無ければ「－」表示
        const typesText = row.types ? row.types : '－';

        tr.innerHTML = `
          <td>${row.date || '－'}</td>
          <td>${row.time || '－'}</td>
          <td>${row.status || '－'}</td>
          <td>${typesText}</td>
        `;

        tbody.appendChild(tr);
      });
    }

    function loadAlertLog() {
      const apiUrl = 'https://script.google.com/macros/s/AKfycby1p3Mof7PFalZmzISlNjDG4iRQgVkFMcAacn229jtO09_a3zgM0eWAUT3n5wRsHKparQ/exec?page=alert-log&callback=jsonpCallback';

      const oldScript = document.getElementById('jsonpScript');
      if (oldScript) oldScript.remove();

      const script = document.createElement('script');
      script.src = apiUrl;
      script.id = 'jsonpScript';
      document.body.appendChild(script);
    }

    window.onload = loadAlertLog;
  </script>
</body>
</html>
